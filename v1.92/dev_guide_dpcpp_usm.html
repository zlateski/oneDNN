<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>DNNL: DPC++ Unified Shared Memory Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">Deep Neural Network Library (DNNL)
   &#160;<span id="projectnumber">1.92.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">DPC++ Unified Shared Memory Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Unified Shared Memory (USM) is a DPC++ capability that provides the ability to allocate and use memory in a uniform way on host and DPC++ devices.</p>
<p>DNNL enables you to use two sets of interfaces with memory: SYCL buffers-based and USM-based. This is controlled by the special macros: <code>DNNL_USE_SYCL_BUFFERS</code> for SYCL buffers (which is the default) and <code>DNNL_USE_DPCPP_USM</code> for USM. The corresponding macro must be defined to enable SYCL buffers or USM interfaces.</p>
<p>For example, to enable USM interfaces in DNNL, the user must pass the <code>DNNL_USE_DPCPP_USM</code> macro:</p>
<div class="fragment"><div class="line">${CXX} application.cpp -DDNNL_USE_DPCPP_USM ...</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>SYCL buffers and USM interfaces cannot be used together in a single application. With the <code>DNNL_USE_SYCL_BUFFERS</code> macro defined, the library provides interfaces working with SYCL buffers only and DNNL memory objects are always constructed with SYCL buffers. With the <code>DNNL_USE_DPCPP_USM</code> macro defined, the library provides interfaces working with USM only and DNNL memory objects are always constructed with USM memory.</dd></dl>
<h2>API</h2>
<p>DNNL provides the following interfaces to work with USM memory:</p>
<ul>
<li><p class="startli"><code>memory mem(md, eng);</code></p>
<p class="startli">Constructs a memory object from an internally allocated USM memory using <code>cl::sycl::malloc_shared()</code>. The constructed object owns the allocated USM memory, which is deallocated on destruction of the object.</p>
</li>
<li><p class="startli"><code>memory mem(md, eng, usm_ptr);</code></p>
<p class="startli">Constructs a memory object from a USM pointer. The constructed object does not own the passed USM memory. The user is reponsible for deallocation of <code>usm_ptr</code>.</p>
</li>
<li><p class="startli"><code>usm_ptr = mem.get_data_handle();</code></p>
<p class="startli">Returns the USM pointer, associated with a memory object.</p>
</li>
<li><p class="startli"><code>mem.set_data_handle(usm_ptr);</code></p>
<p class="startli">Sets the USM pointer, associated with a memory object. Any previously owned USM memory will be deallocated by the memory object.</p>
</li>
</ul>
<h2>Handling Dependencies with USM</h2>
<p>SYCL queues from the SYCL 1.2.1 specification are inherently out-of-order. That means that the order of execution is defined by the dependencies between SYCL tasks. The runtime tracks dependencies based on accessors created for SYCL buffers. USM pointers cannot be used to create accessors and users must handle dependencies on their own using SYCL events.</p>
<p>DNNL provides two mechanisms to handle dependencies when USM memory is used:</p>
<ol type="1">
<li><p class="startli"><code>primitive::execute_sycl()</code> interface</p>
<p class="startli">This interface enables you to pass dependencies between primitives using SYCL events. In this case, the user is responsible for passing proper dependencies for every primitive execution.</p>
</li>
<li><p class="startli">In-order DNNL stream</p>
<p class="startli">DNNL enables you to create in-order streams when submitted primitives are executed in the order they were submitted. Using in-order streams prevents possible read-before-write or concurrent read/write issues.</p>
<dl class="section note"><dt>Note</dt><dd>Performance with in-order DNNL streams with the DPC++ runtime may be suboptimal due to the lack of in-order queue support in the SYCL 1.2.1 specification.</dd></dl>
<h2>SYCL Buffers and DPC++ USM Interfaces</h2>
</li>
</ol>
<p>The tables below summarize the behavior of the DNNL interfaces for working with memory.</p>
<h3>For constructors:</h3>
<table class="doxtable">
<tr>
<th align="left">Macro defined </th><th align="left"><code>memory mem(md, eng)</code> </th><th align="left"><code>memory mem(md, eng, ptr)</code>  </th></tr>
<tr>
<td align="left"><code>DNNL_USE_SYCL_BUFFERS</code> (default) </td><td align="left">Create memory object with SYCL buffer </td><td align="left">Can be used only if <code>ptr</code> is either <code>DNNL_MEMORY_NONE</code> or <code>DNNL_MEMORY_ALLOCATE</code> </td></tr>
<tr>
<td align="left"><code>DNNL_USE_DPCPP_USM</code> </td><td align="left">Create memory object with USM memory </td><td align="left">Use user-provided USM pointer to construct memory object </td></tr>
</table>
<h3>For get and set functions:</h3>
<table class="doxtable">
<tr>
<th align="left">Macro defined </th><th align="left"><code>ptr = mem.get_data_handle()</code> </th><th align="left"><code>mem.set_data_handle(ptr)</code>  </th></tr>
<tr>
<td align="left"><code>DNNL_USE_SYCL_BUFFERS</code> (default) </td><td align="left">Return pointer to the SYCL buffer </td><td align="left">Dereference <code>ptr</code> as a SYCL buffer and copy it </td></tr>
<tr>
<td align="left"><code>DNNL_USE_DPCPP_USM</code> </td><td align="left">Return the USM pointer </td><td align="left">Set the USM pointer </td></tr>
</table>
</div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>