<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>DNNL: Inner Product</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">Deep Neural Network Library (DNNL)
   &#160;<span id="projectnumber">1.3.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Inner Product </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p></p>
<p><a class="el" href="group__dnnl__api__inner__product.html">API Reference</a></p>
<p></p>
</blockquote>
<p>The inner product primitive (sometimes called fully connected) treats each activation in the minibatch as a vector and computes its product with a weights 2D tensor producing a 2D tensor as an output.</p>
<p>More precisely, let \(\src\), \(\weights\), \(\bias\) and \(\dst\) be \(N \times IC\), \(OC \times IC\), \(OC\), and \(N \times OC\) tensors, respectively (variable names follow the standard <a class="el" href="dev_guide_conventions.html">Naming Conventions</a>). Then:</p>
<p class="formulaDsp">
\[\dst(n, oc) = \bias(oc) + \sum_{ic=0}^{IC-1} \src(n, ic) \cdot \weights(oc, ic)\]
</p>
<p>In cases where the \(\src\) and \(\weights\) tensors have spatial dimensions, they are flattened to 2D. For example, if they are 4D \(N \times IC&#39; \times IH \times IW\) and \(OC \times IC&#39; \times KH \times KW\) tensors, then the formula above is applied with \(IC = IC&#39; \cdot IH \cdot IW\). In such cases, the \(\src\) and \(\weights\) tensors must have equal spatial dimensions (e.g. \(KH = IH\) and \(KW = IW\) for 4D tensors).</p>
<h4>Difference Between Forward Training and Forward Inference</h4>
<p>There is no difference between the <a class="el" href="group__dnnl__api__attributes.html#ggac7db48f6583aa9903e54c2a39d65438fa24775787fab8f13aa4809e1ce8f82aeb">dnnl::prop_kind::forward_training</a> and <a class="el" href="group__dnnl__api__attributes.html#ggac7db48f6583aa9903e54c2a39d65438fa3b9fad4f80d45368f856b5403198ac4c">dnnl::prop_kind::forward_inference</a> propagation kinds.</p>
<h3>Backward</h3>
<p>The backward propagation computes \(\diffsrc\) based on \(\diffdst\) and \(\weights\).</p>
<p>The weights update computes \(\diffweights\) and \(\diffbias\) based on \(\diffdst\) and \(\src\).</p>
<dl class="section note"><dt>Note</dt><dd>The <em>optimized</em> memory formats \(\src\) and \(\weights\) might be different on forward propagation, backward propagation, and weights update.</dd></dl>
<h2>Execution Arguments</h2>
<p>When executed, the inputs and outputs should be mapped to an execution argument index as specified by the following table. </p>
<table class="doxtable">
<tr>
<th>Primitive input/output </th><th>Execution argument index  </th></tr>
<tr>
<td>\(\src\) </td><td>DNNL_ARG_SRC </td></tr>
<tr>
<td>\(\weights\) </td><td>DNNL_ARG_WEIGHTS </td></tr>
<tr>
<td>\(\bias\) </td><td>DNNL_ARG_BIAS </td></tr>
<tr>
<td>\(\dst\) </td><td>DNNL_ARG_DST </td></tr>
<tr>
<td>\(\diffsrc\) </td><td>DNNL_ARG_DIFF_SRC </td></tr>
<tr>
<td>\(\diffweights\) </td><td>DNNL_ARG_DIFF_WEIGHTS </td></tr>
<tr>
<td>\(\diffbias\) </td><td>DNNL_ARG_DIFF_BIAS </td></tr>
<tr>
<td>\(\diffdst\) </td><td>DNNL_ARG_DIFF_DST </td></tr>
</table>
<h2>Implementation Details</h2>
<h3>General Notes</h3>
<p>N/A.</p>
<h3>Data Types</h3>
<p>Inner product primitive supports the following combination of data types for source, destination, weights, and bias:</p>
<table class="doxtable">
<tr>
<th align="left">Propagation </th><th align="left">Source </th><th align="left">Weights </th><th align="left">Destination </th><th align="left">Bias  </th></tr>
<tr>
<td align="left">forward / backward </td><td align="left">f32 </td><td align="left">f32 </td><td align="left">f32 </td><td align="left">f32 </td></tr>
<tr>
<td align="left">forward </td><td align="left">f16 </td><td align="left">f16 </td><td align="left">f16 </td><td align="left">f16 </td></tr>
<tr>
<td align="left">forward </td><td align="left">u8, s8 </td><td align="left">s8 </td><td align="left">u8, s8, s32, f32 </td><td align="left">u8, s8, s32, f32 </td></tr>
<tr>
<td align="left">forward </td><td align="left">bf16 </td><td align="left">bf16 </td><td align="left">f32, bf16 </td><td align="left">f32, bf16 </td></tr>
<tr>
<td align="left">backward </td><td align="left">f32, bf16 </td><td align="left">bf16 </td><td align="left">bf16 </td><td align="left"></td></tr>
<tr>
<td align="left">weights update </td><td align="left">bf16 </td><td align="left">f32, bf16 </td><td align="left">bf16 </td><td align="left">f32, bf16 </td></tr>
</table>
<h3>Data Representation</h3>
<p>Like other CNN primitives, the inner product primitive expects the following tensors:</p>
<table class="doxtable">
<tr>
<th align="left">Spatial </th><th align="left">Source </th><th align="left">Destination </th><th align="left">Weights  </th></tr>
<tr>
<td align="left">1D </td><td align="left">\(N \times C \times W\) </td><td align="left">\(N \times C\) </td><td align="left">\(OC \times IC \times KW\) </td></tr>
<tr>
<td align="left">2D </td><td align="left">\(N \times C \times H \times W\) </td><td align="left">\(N \times C\) </td><td align="left">\(OC \times IC \times KH \times KW\) </td></tr>
<tr>
<td align="left">3D </td><td align="left">\(N \times C \times D \times H \times W\) </td><td align="left">\(N \times C\) </td><td align="left">\(OC \times IC \times KD \times KH \times KW\) </td></tr>
</table>
<p>Memory format of data and weights memory objects is critical for inner product primitive performance. In the DNNL programming model, inner product primitive is one of the few primitives that support the placeholder format <a class="el" href="structdnnl_1_1memory.html#a8e71077ed6a5f7fb7b3e6e1a5a2ecf3fa100b8cad7cf2a56f6df78f171f97a1ec" title="Placeholder memory format tag. ">dnnl::memory::format_tag::any</a> (shortened to <code>any</code> from now on) and can define data and weight memory objects formats based on the primitive parameters. When using <code>any</code> it is necessary to first create an inner product primitive descriptor and then query it for the actual data and weight memory objects formats.</p>
<p>The table below shows the combinations for which <b>plain</b> memory formats the inner product primitive is optimized for. For the destination tensor (which is always \(N \times C\)) the memory format is always <a class="el" href="structdnnl_1_1memory.html#a8e71077ed6a5f7fb7b3e6e1a5a2ecf3fa1e7342845e24eb3b5b3554490da1c128" title="2D CNN activations tensor; an alias for dnnl::memory::format_tag::ab ">dnnl::memory::format_tag::nc</a> (<a class="el" href="structdnnl_1_1memory.html#a8e71077ed6a5f7fb7b3e6e1a5a2ecf3fa187ef4436122d1cc2f40dc2b92f0eba0" title="plain 2D tensor ">dnnl::memory::format_tag::ab</a>).</p>
<table class="doxtable">
<tr>
<th align="left">Spatial </th><th align="left">Source / Weights logical tensor </th><th align="left">Implementation optimized for memory formats  </th></tr>
<tr>
<td align="left">0D </td><td align="left">NC / OI </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dac08a541001fe70289305a5fbde48906d" title="2D CNN activations tensor, an alias to dnnl_ab ">dnnl_nc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da1bd907fc29344dfe7ba88336960dcf53" title="plain 2D tensor ">dnnl_ab</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daee91ff6fadfe8c5494be1595fd253c4e" title="2D CNN weights tensor, an alias to dnnl_ab ">dnnl_oi</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da1bd907fc29344dfe7ba88336960dcf53" title="plain 2D tensor ">dnnl_ab</a>) </td></tr>
<tr>
<td align="left">0D </td><td align="left">NC / OI </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dac08a541001fe70289305a5fbde48906d" title="2D CNN activations tensor, an alias to dnnl_ab ">dnnl_nc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da1bd907fc29344dfe7ba88336960dcf53" title="plain 2D tensor ">dnnl_ab</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da46de139a50746a1a22d8d33c60d9081b" title="2D CNN weights tensor, an alias to dnnl_ba ">dnnl_io</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da6a6dbc0b30468d92e32a9cb3f6615c43" title="permuted 2D tensor ">dnnl_ba</a>) </td></tr>
<tr>
<td align="left">1D </td><td align="left">NCW / OIW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dab55cb1d54480dd7f796bf66eea3ad32f" title="3D CNN activations tensor, an alias to dnnl_abc ">dnnl_ncw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dadff5ea69392d7e4da23179dc0ba7cbc2" title="plain 3D tensor ">dnnl_abc</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae6bd836b8515857585336a0921e35663" title="3D CNN weights tensor, an alias to dnnl_abc ">dnnl_oiw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dadff5ea69392d7e4da23179dc0ba7cbc2" title="plain 3D tensor ">dnnl_abc</a>) </td></tr>
<tr>
<td align="left">1D </td><td align="left">NCW / OIW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da9f756dbdc1e949646c95f83e0f51bc43" title="3D CNN activations tensor, an alias to dnnl_acb ">dnnl_nwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daf8537ed269eb5d0586456db114039c00" title="permuted 3D tensor ">dnnl_acb</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da93eecc25f8ab1b07604b632401aa28e5" title="3D CNN weights tensor, an alias to dnnl_cba ">dnnl_wio</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da5a8de15eee2e5bcc2515eb7b01965789" title="permuted 3D tensor ">dnnl_cba</a>) </td></tr>
<tr>
<td align="left">2D </td><td align="left">NCHW / OIHW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da83a751aedeb59613312339d0f8b90f54" title="4D CNN activations tensor, an alias to dnnl_abcd ">dnnl_nchw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da6e669cc61278663a5ddbd3d0b25c6c5c" title="plain 4D tensor ">dnnl_abcd</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da11176ff202375dcd0d06e2fba5f8a8e0" title="4D CNN weights tensor, an alias to dnnl_abcd ">dnnl_oihw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da6e669cc61278663a5ddbd3d0b25c6c5c" title="plain 4D tensor ">dnnl_abcd</a>) </td></tr>
<tr>
<td align="left">2D </td><td align="left">NCHW / OIHW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae50c534446b3c18cc018b3946b3cebd7" title="4D CNN activations tensor, an alias to dnnl_acdb ">dnnl_nhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da8fcce5dd7260b5b0740e3b37b1e9ad41" title="permuted 4D tensor ">dnnl_acdb</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da4f4c7bd98c6d53fb3b69e1c8df0a80f6" title="4D CNN weights tensor, an alias to dnnl_cdba ">dnnl_hwio</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da2368e1a4ce9d9954fa10c242569eacb4" title="permuted 4D tensor ">dnnl_cdba</a>) </td></tr>
<tr>
<td align="left">3D </td><td align="left">NCDHW / OIDHW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae33b8c6790e5d37324f18a019658d464" title="5D CNN activations tensor, an alias to dnnl_abcde ">dnnl_ncdhw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da30d5d3c9de2931f06d265af81787ada3" title="plain 5D tensor ">dnnl_abcde</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da18e605a5f6afe9995961fc21fddf314e" title="5D CNN weights tensor, an alias to dnnl_abcde ">dnnl_oidhw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da30d5d3c9de2931f06d265af81787ada3" title="plain 5D tensor ">dnnl_abcde</a>) </td></tr>
<tr>
<td align="left">3D </td><td align="left">NCDHW / OIDHW </td><td align="left"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daa0d8b24eefd029e214080d3787114fc2" title="5D CNN activations tensor, an alias to dnnl_acdeb ">dnnl_ndhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da0cfe86402763786b9b4d73062cfd2f05" title="permuted 5D tensor ">dnnl_acdeb</a>) / <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae4885779f955beeddc25443a3f8c2a63" title="5D CNN weights tensor, an alias to dnnl_cdeba ">dnnl_dhwio</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae7dd2b81eb2b502efbf65c888665b358" title="permuted 5D tensor ">dnnl_cdeba</a>) </td></tr>
</table>
<h3>Post-ops and Attributes</h3>
<p>Post-ops and attributes enable you to modify the behavior of the inner product primitive by chaining certain operations after the inner product operation. The following post-ops are supported by inner product primitives:</p>
<table class="doxtable">
<tr>
<th align="left">Propagation </th><th align="left">Type </th><th align="left">Operation </th><th align="left">Description  </th></tr>
<tr>
<td align="left">forward </td><td align="left">post-op </td><td align="left">eltwise </td><td align="left">Applies an <a class="el" href="group__dnnl__api__eltwise.html">Eltwise</a> operation to the result </td></tr>
</table>
<h2>Implementation Limitations</h2>
<ol type="1">
<li>Check <a class="el" href="dev_guide_data_types.html">Data Types</a>.</li>
</ol>
<h2>Performance Tips</h2>
<ul>
<li>Use <a class="el" href="structdnnl_1_1memory.html#a8e71077ed6a5f7fb7b3e6e1a5a2ecf3fa100b8cad7cf2a56f6df78f171f97a1ec" title="Placeholder memory format tag. ">dnnl::memory::format_tag::any</a> for source, weights, and destinations memory format tags when create an inner product primitive to allow the library to choose the most appropriate memory format. </li>
</ul>
</div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>