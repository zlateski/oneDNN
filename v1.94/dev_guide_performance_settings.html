<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>oneDNN: Performance Settings for Benchmarking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">oneAPI Deep Neural Network Library (oneDNN)
   &#160;<span id="projectnumber">1.94.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Performance Settings for Benchmarking </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following settings are recommended for measuring oneDNN performance using benchdnn. When measuring performance using any deep learning framework, refer to its benchmarking documentation. However, the approach outlined below is true for almost any compute-intensive application.</p>
<h1>CPU</h1>
<h2>Threading Runtimes</h2>
<p>It is a common practice to affinitize each compute thread to its own CPU core when benchmarking performance. The method to do this depends on the threading library used.</p>
<p>TBB intentionally does not provide a mechanism to control affinity or number of threads via environment variables. However, TBB does create threads based on the number of CPUs in the process <a href="https://en.wikipedia.org/wiki/Affinity_mask">CPU affinity mask</a> at the time the library is initialized. This means that some of the examples below work for TBB as well. Additionally, TBB implements an observer mechanism that can be used to <a href="https://www.threadingbuildingblocks.org/docs/help/reference/task_scheduler/task_scheduler_observer.html">affinitize threads</a>.</p>
<p>This document focuses on OpenMP runtime that has portable controls for thread affinity documented <a href="https://www.openmp.org/spec-html/5.0/openmpch6.html#x287-20510006">here</a>. It should be noted that the OpenMP runtime that comes with Microsoft Visual studio does not support them nor does it provide any other ways to control thread affinity.</p>
<h2>Benchmarking Settings</h2>
<p>The general principles below are not operating system-specific. However, of all operating systems supported by oneDNN only Linux has the <a href="https://linux.die.net/man/8/numactl">numactl(8)</a> utility that makes it easy to demonstrate them. NUMA stands for non-uniform memory access which is the typical architecture of the modern CPUs in which individual sockets have their own memory with separate physical memory attached. NUMA configuration is possible even within a single socket when a socket consists of multiple chips or tiles or when sub-NUMA clustering configurations are enabled.</p>
<p>Also, many modern CPUs may have multiple hardware threads per CPU core enabled. Such threads are usually exposed by OS as additional logical processors (thus a system with 4 cores and 2 hardware threads per core has 8 logical processors). If this is the case, the recommendation is to use only one of hardware threads per core.</p>
<p>There are three most important setup variants when benchmarking oneDNN on CPU:</p>
<ul>
<li><em>Whole machine</em>. It is generally not recommended but can be used when it is not possible or desirable to split work among multiple instances.</li>
<li><em>Single NUMA domain</em>. This setup is the recommended one. It can be used for throughput-oriented inference and training with multiple instances.</li>
<li><em>Several cores within the same NUMA domain</em>. This setup is recommended for latency-oriented small- or single-minibatch cases. This document does not discuss how to actually setup a multi-instance environment.</li>
</ul>
<h3>Whole Machine</h3>
<p>Typically a modern server CPU is configured to have multiple NUMA domains. When running benchmarks on a whole machine, it is best to instruct the OS to interleave physical memory allocation between those domains. This way the computations have a higher chance to access physical memory from a local domain and thus there is less cross-node traffic. This also lowers run-to-run variation.</p>
<div class="fragment"><div class="line">$ export OMP_PROC_BIND=spread</div>
<div class="line">$ export OMP_PLACES=threads</div>
<div class="line">$ export OMP_NUM_THREADS=# number of cores in the system</div>
<div class="line">$ numactl --interleave=<a class="code" href="group__dnnl__api__service.html#ggabad017feb1850634bf3babdb68234f83aa181a603769c1f98ad927e7367c7aa51">all</a> ./benchdnn ...</div>
</div><!-- fragment --><h3>Single NUMA Domain</h3>
<p>Here we instruct <code>numactl</code> to affinitize process to NUMA domain 0 both in terms of CPU and memory locality.</p>
<div class="fragment"><div class="line">$ export OMP_PROC_BIND=spread</div>
<div class="line">$ export OMP_PLACES=threads</div>
<div class="line">$ export OMP_NUM_THREADS=# number of cores in NUMA domain 0</div>
<div class="line">$ numactl --membind 0 --cpunodebind 0 ./benchdnn ...</div>
</div><!-- fragment --><h3>Several Cores Within a NUMA Domain</h3>
<p>In this case we want to use <code>numactl</code> options from the single NUMA domain scenario, but place OpenMP threads close one to another.</p>
<div class="fragment"><div class="line">$ export OMP_PROC_BIND=close</div>
<div class="line">$ export OMP_PLACES=threads</div>
<div class="line">$ export OMP_NUM_THREADS=# desired number of cores to use</div>
<div class="line">$ numactl --membind 0 --cpunodebind 0 ./benchdnn ...</div>
</div><!-- fragment --><p>Unfortunately, this does not work when there are multiple hardware threads per CPU, OpenMP runtimes place multiple threads on each core with the settings above. Moreover, there is no way to describe the desired configuration in which there is only one OpenMP thread per core without listing the corresponding logical processors explicitly on the command line via <code>numactl --physcpubind=&lt;list&gt;</code> (not shown here) or using non-portable environment variables supported by OpenMP runtimes based on the Intel OpenMP runtime (Clang, Intel C/C++ Compiler):</p>
<div class="fragment"><div class="line">$ export KMP_HW_SUBSET=1T # Use 1 hardware thread per core</div>
<div class="line">$ export OMP_PROC_BIND=close</div>
<div class="line">$ export OMP_PLACES=threads</div>
<div class="line">$ export OMP_NUM_THREADS=# desired number of cores to use</div>
<div class="line">$ numactl --membind 0 --cpunodebind 0 ./benchdnn ...</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>It is safe to set <code>KMP_HW_SUBSET=1T</code> even if the machine is configured with a single hardware thread per core. It also makes it unnecessary to set <code>OMP_NUM_THREADS</code> in all the scenarios but the last as the number of threads is then inferred from the total number of logical processors in the process CPU affinity mask. </dd></dl>
</div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>