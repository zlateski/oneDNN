<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>oneDNN: Primitive Attributes: Scratchpad</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">oneAPI Deep Neural Network Library (oneDNN)
   &#160;<span id="projectnumber">1.94.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Primitive Attributes: Scratchpad </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Some primitives might require a temporary buffer while performing their computations. For instance, the operations that do not have enough independent work to utilize all cores on a system might use parallelization over the reduction axis (e.g. k-axis in matrix-matrix multiplication). In this case the threads compute partial results in a temporary buffer and once finished the library reduces partial results into the final one. Another example is a convolution implementation that uses GEMM. Before using a GEMM the source images needs to be rearranged by so-called <code>im2col</code> transformation. The transformation happens in a temporary buffer that is then used as an input for GEMM.</p>
<p>In both of these examples, the temporary buffer is no longer required once the primitive computation is completed. oneDNN refers to such a memory buffer as a <b>scratchpad</b>.</p>
<dl class="section warning"><dt>Warning</dt><dd>Do not confuse <b>scratchpad</b> with <a class="el" href="dev_guide_inference_and_training_aspects.html#dev_guide_inference_and_training_aspects_workspace">Workspace</a>. The workspace is a buffer that is shared between forward and backward propagation of a primitive (hence <b>must</b> be preserved between the calls) and is used only in training.</dd></dl>
<p>The amount of space required for the scratchpad depends on the primitive and its actual implementation. For example, the GEMM-based convolution requires a scratchpad for the <code>im2col</code> data, while the direct convolution does not.</p>
<p>Both types of implementation might need extra space for the reduction in case there are too few independent tasks. The <code>im2col</code> size is proportional to the size of the source image multiplied by the weights spatial size. The size of a buffer for reduction is proportional to the tensor size to be reduced (e.g., <code>diff_weights</code> in the case of backward by weights) multiplied by the number of threads in the reduction groups (the upper bound is the overall number of threads).</p>
<p>By contrast, some other primitives might require very little extra space. For instance, one of the implementation of the <a class="el" href="structdnnl_1_1sum.html">dnnl::sum</a> primitive requires temporary space only to store the pointers to data for each and every input array (that is, the size of the scratchpad is <code>n * sizeof(void *)</code>, where <code>n</code> is the number of summands).</p>
<p>oneDNN supports two modes for handling scratchpads:</p>
<ol type="1">
<li><a class="el" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07fad521f765a49c72507257a2620612ee96" title="The library manages the scratchpad allocation according to the policy specified by the DNNL_ENABLE_CO...">dnnl::scratchpad_mode::library</a>. The library allocates memory for each primitive during its creation. This is the <b>default</b> behavior which enables user to not worry about the scratchpad at all. The scratchpad management policy can be configured at compile-time using the DNNL_ENABLE_CONCURRENT_EXEC (<a class="el" href="dev_guide_build_options.html">Build Options</a>) cmake option.<ul>
<li>When DNNL_ENABLE_CONCURRENT_EXEC=OFF (<b>default</b>), a global scratchpad memory is shared across primitives. This mode minimizes the amount of memory needed for scratchpads at the application level. The global scratchpad is freed when all the primitives referencing it are destroyed. <dl class="section warning"><dt>Warning</dt><dd>In this mode, primitives can be created and executed in parallel but must be executed in the same thread they were created in. Executing primitives in a different thread than the one they were created in will result in segmentation fault. If you might execute a primitive in a thread different than the one it was created in, consider using <a class="el" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee" title="The user manages the scratchpad allocation by querying and providing the scratchpad memory to primiti...">dnnl::scratchpad_mode::user</a> or DNNL_ENABLE_CONCURRENT_EXEC=ON.</dd></dl>
</li>
<li>When DNNL_ENABLE_CONCURRENT_EXEC=ON, each primitive allocates its own private scratchpad memory. The scratchpad memory is freed when its primitive is destroyed. This mode can lead to larger memory footprint when compared to DNNL_ENABLE_CONCURRENT_EXEC=OFF. <dl class="section warning"><dt>Warning</dt><dd>In this mode, primitives can be created in one thread and executed in another. Also, different primitives can be run concurrently. If the same primitive is run from two different threads concurrently, the library will return incorrect results. If you might run the same primitive in two threads concurrently, consider using <a class="el" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee" title="The user manages the scratchpad allocation by querying and providing the scratchpad memory to primiti...">dnnl::scratchpad_mode::user</a> or DNNL_ENABLE_CONCURRENT_EXEC=OFF.</dd></dl>
</li>
</ul>
</li>
<li><a class="el" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee" title="The user manages the scratchpad allocation by querying and providing the scratchpad memory to primiti...">dnnl::scratchpad_mode::user</a>. A user provides scratchpad memory that has sufficient space at primitive execution (using the <code>DNNL_ARG_SCRATCHPAD</code> tag). This enables the user to reuse the memory as well as to make the primitives thread-safe. However, this requires a good memory manager (in terms of speed and locality) on the user's side.</li>
</ol>
<dl class="section warning"><dt>Warning</dt><dd>Primitives are not thread-safe by default. The only way to make the primitive execution fully thread-safe is to use the <a class="el" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee" title="The user manages the scratchpad allocation by querying and providing the scratchpad memory to primiti...">dnnl::scratchpad_mode::user</a> mode and not pass the same scratchpad memory to two primitives that are executed concurrently.</dd></dl>
<p>The scratchpad mode is controlled though the <a class="el" href="group__dnnl__api__attributes.html#ga4adeb17e538392ec3a16d2f6ef3f7cca">dnnl_primitive_attr_set_scratchpad_mode</a> (C API) and <a class="el" href="structdnnl_1_1primitive__attr.html#a91a597649afa13b7d2416b708d0620d2">dnnl::primitive_attr::set_scratchpad_mode</a> (C++ API) primitive attributes, and should be passed during the primitive descriptor creation (<a class="el" href="dev_guide_attributes.html">Primitive Attributes</a>).</p>
<p>It is worth mentioning that all primitives support both scratchpad modes. That is, primitive descriptor creation success or failure cannot depend on the scratchpad mode used.</p>
<h2>Scratchpad Memory Engine</h2>
<p>If the user provides scratchpad memory to a primitive, this memory must be created using the same engine that the primitive uses.</p>
<h2>Examples</h2>
<h4>Library Manages Scratchpad</h4>
<p>As mentioned above, this is a default behavior. We only want to highlight how a user can query the amount of memory consumed by a primitive due to a scratchpad.</p>
<div class="fragment"><div class="line"><span class="comment">// Use default attr, hence the library allocates scratchpad</span></div>
<div class="line">dnnl::primitive::primitive_desc op_pd(params, ...);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Print how much memory would be hold by a primitive due to scratchpad</span></div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;primitive will use &quot;</span></div>
<div class="line">          &lt;&lt; op_pd.query_s64(<a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a0ed44d67e94c1c7ac5f219491e422506">dnnl::query::memory_consumption_s64</a>)</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; bytes&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line"><span class="comment">// In this case scratchpad is internal, hence user visible scratchpad memory</span></div>
<div class="line"><span class="comment">// descriptor should be empty:</span></div>
<div class="line"><span class="keyword">auto</span> zero_md = <a class="code" href="structdnnl_1_1memory_1_1desc.html">dnnl::memory::desc</a>();</div>
<div class="line">assert(op_pd.scratchpad_desc() == zero_md);</div>
</div><!-- fragment --><h4>User Manages Scratchpad</h4>
<div class="fragment"><div class="line"><span class="comment">// Create an empty (default) attributes</span></div>
<div class="line"><a class="code" href="structdnnl_1_1primitive__attr.html">dnnl::primitive_attr</a> attr;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Default scratchpad mode is `library`:</span></div>
<div class="line">assert(attr.<a class="code" href="structdnnl_1_1primitive__attr.html#a05ff5d73eae0eba28b341b5d2b6186a7">get_scratchpad_mode</a>() == <a class="code" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07fad521f765a49c72507257a2620612ee96">dnnl::scratchpad_mode::library</a>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Set scratchpad mode to `user`</span></div>
<div class="line">attr.<a class="code" href="structdnnl_1_1primitive__attr.html#a91a597649afa13b7d2416b708d0620d2">set_scratchpad_mode</a>(<a class="code" href="group__dnnl__api__attributes.html#ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee">dnnl::scratchpad_mode::user</a>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create a primitive descriptor with custom attributes</span></div>
<div class="line">dnnl::primitive::primitive_desc op_pd(op_d, attr, engine);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Query the scratchpad memory descriptor</span></div>
<div class="line"><a class="code" href="structdnnl_1_1memory_1_1desc.html">dnnl::memory::desc</a> <a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a9cbdd03b65c030ef560b5555be1a86c2">scratchpad_md</a> = op_pd.scratchpad_desc();</div>
<div class="line"></div>
<div class="line"><span class="comment">// Note, that a primitive doesn&#39;t consume memory in this configuration:</span></div>
<div class="line">assert(op_pd.query_s64(<a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a0ed44d67e94c1c7ac5f219491e422506">dnnl::query::memory_consumption_s64</a>) == 0);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Create a primitive</span></div>
<div class="line"><a class="code" href="structdnnl_1_1primitive.html">dnnl::primitive</a> prim(op_pd);</div>
<div class="line"></div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Create a scratchpad memory</span></div>
<div class="line"><span class="comment">// NOTE: if scratchpad is not required for a particular primitive the</span></div>
<div class="line"><span class="comment">//       scratchpad_md.get_size() will return 0. It is fine to have</span></div>
<div class="line"><span class="comment">//       scratchpad_ptr == nullptr in this case.</span></div>
<div class="line"><span class="keywordtype">void</span> *scratchpad_ptr = user_memory_manager::allocate(scratchpad_md.<a class="code" href="structdnnl_1_1memory_1_1desc.html#a3a12698f833b44ed55af9fc6621c4917">get_size</a>());</div>
<div class="line"><span class="comment">// NOTE: engine here must much the engine of the primitive</span></div>
<div class="line"><a class="code" href="structdnnl_1_1memory.html">dnnl::memory</a> scratchpad(scratchpad_md, engine, scratchpad_ptr);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Pass a scratchpad memory to a primitive</span></div>
<div class="line">prim.execute(stream, {</div>
<div class="line">        ...,</div>
<div class="line">        {<a class="code" href="group__dnnl__api__primitives__common.html#ga81836a4db2cb1c4a14d959e304d3f63d">DNNL_ARG_SCRATCHPAD</a>, scratchpad}});</div>
</div><!-- fragment --> </div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>