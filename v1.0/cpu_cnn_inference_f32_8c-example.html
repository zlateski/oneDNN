<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Intel(R) MKL-DNN: cpu_cnn_inference_f32.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">Intel(R) Math Kernel Library for Deep Neural Networks (Intel(R) MKL-DNN)
   &#160;<span id="projectnumber">1.0.4</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">cpu_cnn_inference_f32.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This C API example demonstrates how to build an AlexNet neural network topology for forward-pass inference. </p>
<blockquote class="doxtable">
<p>Annotated version: <a class="el" href="cpu_cnn_inference_f32_c.html">CNN f32 inference example</a> </p>
</blockquote>
<div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Copyright 2016-2019 Intel Corporation</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><span class="comment">* you may not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment">* You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*     http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment">* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><span class="comment">* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment">* See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment">* limitations under the License.</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Required for posix_memalign</span></div>
<div class="line"><span class="preprocessor">#define _POSIX_C_SOURCE 200112L</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="mkldnn_8h.html">mkldnn.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define BATCH 8</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define IC 3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define OC 96</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_IH 227</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_IW 227</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_OH 55</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_OW 55</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_STRIDE 4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CONV_PAD 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POOL_OH 27</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POOL_OW 27</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POOL_STRIDE 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define POOL_PAD 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CHECK(f)                                                             \</span></div>
<div class="line"><span class="preprocessor">    do {                                                                     \</span></div>
<div class="line"><span class="preprocessor">        mkldnn_status_t s = f;                                               \</span></div>
<div class="line"><span class="preprocessor">        if (s != mkldnn_success) {                                           \</span></div>
<div class="line"><span class="preprocessor">            printf(&quot;[%s:%d] error: %s returns %d\n&quot;, __FILE__, __LINE__, #f, \</span></div>
<div class="line"><span class="preprocessor">                    s);                                                      \</span></div>
<div class="line"><span class="preprocessor">            exit(2);                                                         \</span></div>
<div class="line"><span class="preprocessor">        }                                                                    \</span></div>
<div class="line"><span class="preprocessor">    } while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CHECK_TRUE(expr)                                              \</span></div>
<div class="line"><span class="preprocessor">    do {                                                              \</span></div>
<div class="line"><span class="preprocessor">        int e_ = expr;                                                \</span></div>
<div class="line"><span class="preprocessor">        if (!e_) {                                                    \</span></div>
<div class="line"><span class="preprocessor">            printf(&quot;[%s:%d] %s failed\n&quot;, __FILE__, __LINE__, #expr); \</span></div>
<div class="line"><span class="preprocessor">            exit(2);                                                  \</span></div>
<div class="line"><span class="preprocessor">        }                                                             \</span></div>
<div class="line"><span class="preprocessor">    } while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> product(<a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> *arr, <span class="keywordtype">size_t</span> size) {</div>
<div class="line">    <span class="keywordtype">size_t</span> prod = 1;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; ++i)</div>
<div class="line">        prod *= arr[i];</div>
<div class="line">    <span class="keywordflow">return</span> prod;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">int</span> nargs;</div>
<div class="line">    <a name="_a0"></a><a class="code" href="structmkldnn__exec__arg__t.html">mkldnn_exec_arg_t</a> *args;</div>
<div class="line">} args_t;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> prepare_arg_node(args_t *node, <span class="keywordtype">int</span> nargs) {</div>
<div class="line">    node-&gt;args = (<a class="code" href="structmkldnn__exec__arg__t.html">mkldnn_exec_arg_t</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structmkldnn__exec__arg__t.html">mkldnn_exec_arg_t</a>) * nargs);</div>
<div class="line">    node-&gt;nargs = nargs;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> free_arg_node(args_t *node) {</div>
<div class="line">    free(node-&gt;args);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> set_arg(</div>
<div class="line">        <a class="code" href="structmkldnn__exec__arg__t.html">mkldnn_exec_arg_t</a> *arg, <span class="keywordtype">int</span> arg_idx, <a name="_a1"></a><a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> memory) {</div>
<div class="line">    arg-&gt;<a name="a2"></a><a class="code" href="structmkldnn__exec__arg__t.html#a0330f69c98f9c662795bc570c92999dd">arg</a> = arg_idx;</div>
<div class="line">    arg-&gt;<a name="a3"></a><a class="code" href="structmkldnn__exec__arg__t.html#a435bc6c683e834196b7cb3065fec0722">memory</a> = memory;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> init_data_memory(uint32_t dim, <span class="keyword">const</span> <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> *dims,</div>
<div class="line">        <a class="code" href="group__c__api__types__generic.html#gacc2844e341ab1c4f5b7ae1c6068f2a2b">mkldnn_format_tag_t</a> user_tag, <a class="code" href="group__c__api__types__generic.html#ga826b2a9be4d94ac17f99bacac6d0cb29">mkldnn_data_type_t</a> <a name="a4"></a><a class="code" href="group__c__api__types__generic.html#gga826b2a9be4d94ac17f99bacac6d0cb29a6d9faa3e054a4f7b7e5ab5b3d420684e">mkldnn_f32</a>,</div>
<div class="line">        <a name="_a5"></a><a class="code" href="structmkldnn__engine.html">mkldnn_engine_t</a> engine, <span class="keywordtype">float</span> *data, <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> *memory) {</div>
<div class="line">    <a name="_a6"></a><a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> user_md;</div>
<div class="line">    CHECK(<a name="a7"></a><a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(</div>
<div class="line">            &amp;user_md, dim, dims, mkldnn_f32, user_tag));</div>
<div class="line">    CHECK(<a name="a8"></a><a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(memory, &amp;user_md, engine, data));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__c__api__types__generic.html#ga31866789b66acfb1c28b2f9bdd7bdfdd">mkldnn_status_t</a> prepare_reorder(<a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> *user_memory, <span class="comment">// in</span></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *prim_memory_md, <span class="comment">// in</span></div>
<div class="line">        <a class="code" href="structmkldnn__engine.html">mkldnn_engine_t</a> prim_engine, <span class="comment">// in: primitive&#39;s engine</span></div>
<div class="line">        <span class="keywordtype">int</span> dir_is_user_to_prim, <span class="comment">// in: user -&gt; prim or prim -&gt; user</span></div>
<div class="line">        <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> *prim_memory, <span class="comment">// out: primitive&#39;s memory created</span></div>
<div class="line">        <a name="_a9"></a><a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> *reorder, <span class="comment">// out: reorder primitive created</span></div>
<div class="line">        uint32_t *net_index, <span class="comment">// primitive index in net (inc if reorder created)</span></div>
<div class="line">        <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> *net, args_t *net_args) {  <span class="comment">// net params</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *user_memory_md;</div>
<div class="line">    <a name="a10"></a><a class="code" href="group__c__api__memory.html#ga3b9649ef5812e7ab642aa506f02eafda">mkldnn_memory_get_memory_desc</a>(*user_memory, &amp;user_memory_md);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__engine.html">mkldnn_engine_t</a> user_mem_engine;</div>
<div class="line">    <a name="a11"></a><a class="code" href="group__c__api__memory.html#ga6b50538dbdab8f767bb6f734403d79f2">mkldnn_memory_get_engine</a>(*user_memory, &amp;user_mem_engine);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!<a name="a12"></a><a class="code" href="group__c__api__memory.html#gadbe574936bc18227483b2ffe022bad63">mkldnn_memory_desc_equal</a>(user_memory_md, prim_memory_md)) {</div>
<div class="line">        <span class="comment">// memory_create(&amp;p, m, NULL) means allocate memory</span></div>
<div class="line">        CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(prim_memory, prim_memory_md, prim_engine,</div>
<div class="line">                MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line">        <a name="_a13"></a><a class="code" href="structmkldnn__primitive__desc.html">mkldnn_primitive_desc_t</a> reorder_pd;</div>
<div class="line">        <span class="keywordflow">if</span> (dir_is_user_to_prim) {</div>
<div class="line">            CHECK(<a name="a14"></a><a class="code" href="group__c__api__reorder.html#ga042687f1527f4a08eb50cbac86b99ba4">mkldnn_reorder_primitive_desc_create</a>(&amp;reorder_pd,</div>
<div class="line">                    user_memory_md, user_mem_engine, prim_memory_md,</div>
<div class="line">                    prim_engine, NULL));</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            CHECK(<a class="code" href="group__c__api__reorder.html#ga042687f1527f4a08eb50cbac86b99ba4">mkldnn_reorder_primitive_desc_create</a>(&amp;reorder_pd,</div>
<div class="line">                    prim_memory_md, prim_engine, user_memory_md,</div>
<div class="line">                    user_mem_engine, NULL));</div>
<div class="line">        }</div>
<div class="line">        CHECK(<a name="a15"></a><a class="code" href="group__c__api__primitive__common.html#ga7e9dba49f70cef016d9efcb542035eca">mkldnn_primitive_create</a>(reorder, reorder_pd));</div>
<div class="line">        CHECK(<a name="a16"></a><a class="code" href="group__c__api__primitive__common.html#gacad44a12c7d863fb47dc02a76b4b794a">mkldnn_primitive_desc_destroy</a>(reorder_pd));</div>
<div class="line"></div>
<div class="line">        net[*net_index] = *reorder;</div>
<div class="line">        prepare_arg_node(&amp;net_args[*net_index], 2);</div>
<div class="line">        set_arg(&amp;net_args[*net_index].args[0], MKLDNN_ARG_FROM,</div>
<div class="line">                dir_is_user_to_prim ? *user_memory : *prim_memory);</div>
<div class="line">        set_arg(&amp;net_args[*net_index].args[1], MKLDNN_ARG_TO,</div>
<div class="line">                dir_is_user_to_prim ? *prim_memory : *user_memory);</div>
<div class="line">        (*net_index)++;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        *prim_memory = NULL;</div>
<div class="line">        *reorder = NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a name="a17"></a><a class="code" href="group__c__api__types__generic.html#gga31866789b66acfb1c28b2f9bdd7bdfddab50eb3f75584f0495802ffb5e0a9884f">mkldnn_success</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__c__api__types__generic.html#ga31866789b66acfb1c28b2f9bdd7bdfdd">mkldnn_status_t</a> simple_net() {</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__engine.html">mkldnn_engine_t</a> engine;</div>
<div class="line">    CHECK(<a name="a18"></a><a class="code" href="group__c__api__engine.html#gae6368dc7ac5a23b48c1be9669d57d194">mkldnn_engine_create</a>(&amp;engine, <a name="a19"></a><a class="code" href="group__c__api__engine__types.html#ggaec8e96cbc2f19125c9def11efa98aa7ea23ee49a2c81f9299e65252b10eed4557">mkldnn_cpu</a>, 0));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// build a simple net</span></div>
<div class="line">    uint32_t n = 0;</div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> net[10];</div>
<div class="line">    args_t net_args[10];</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> *net_src</div>
<div class="line">            = (<span class="keywordtype">float</span> *)malloc(BATCH * IC * CONV_IH * CONV_IW * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line">    <span class="keywordtype">float</span> *net_dst</div>
<div class="line">            = (<span class="keywordtype">float</span> *)malloc(BATCH * OC * POOL_OH * POOL_OW * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// AlexNet: conv</span></div>
<div class="line">    <span class="comment">// {BATCH, IC, CONV_IH, CONV_IW} (x) {OC, IC, CONV_KH, CONV_KW} -&gt;</span></div>
<div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW}</span></div>
<div class="line">    <span class="comment">// strides: {CONV_STRIDE, CONV_STRIDE}</span></div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_user_src_sizes[4] = { BATCH, IC, CONV_IH, CONV_IW };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_user_weights_sizes[4] = { OC, IC, 11, 11 };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_bias_sizes[4] = { OC };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_user_dst_sizes[4] = { BATCH, OC, CONV_OH, CONV_OW };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_strides[2] = { CONV_STRIDE, CONV_STRIDE };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> conv_padding[2] = { CONV_PAD, CONV_PAD };</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> *conv_src = net_src;</div>
<div class="line">    <span class="keywordtype">float</span> *conv_weights = (<span class="keywordtype">float</span> *)malloc(</div>
<div class="line">            product(conv_user_weights_sizes, 4) * <span class="keyword">sizeof</span>(float));</div>
<div class="line">    <span class="keywordtype">float</span> *conv_bias</div>
<div class="line">            = (<span class="keywordtype">float</span> *)malloc(product(conv_bias_sizes, 1) * <span class="keyword">sizeof</span>(float));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create memory for user data</span></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> conv_user_src_memory, conv_user_weights_memory,</div>
<div class="line">            conv_user_bias_memory;</div>
<div class="line">    init_data_memory(4, conv_user_src_sizes, <a name="a20"></a><a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2baed4a51a8db128a648b942882369a06d6">mkldnn_nchw</a>, mkldnn_f32, engine,</div>
<div class="line">            conv_src, &amp;conv_user_src_memory);</div>
<div class="line">    init_data_memory(4, conv_user_weights_sizes, <a name="a21"></a><a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2bacc2eeaa304a91dc0d8ec301a8a13fa4a">mkldnn_oihw</a>, mkldnn_f32,</div>
<div class="line">            engine, conv_weights, &amp;conv_user_weights_memory);</div>
<div class="line">    init_data_memory(1, conv_bias_sizes, <a name="a22"></a><a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2ba494a09557958694ff1aece6b4667d87f">mkldnn_x</a>, mkldnn_f32, engine,</div>
<div class="line">            conv_bias, &amp;conv_user_bias_memory);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create data descriptors for convolution w/ no specified format</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> conv_src_md, conv_weights_md, conv_bias_md,</div>
<div class="line">            conv_dst_md;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(&amp;conv_src_md, 4, conv_user_src_sizes,</div>
<div class="line">            mkldnn_f32, <a name="a23"></a><a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2bab7f14a435b0c6373badb9b3f296e6c1f">mkldnn_format_tag_any</a>));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(&amp;conv_weights_md, 4,</div>
<div class="line">            conv_user_weights_sizes, mkldnn_f32, <a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2bab7f14a435b0c6373badb9b3f296e6c1f">mkldnn_format_tag_any</a>));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(</div>
<div class="line">            &amp;conv_bias_md, 1, conv_bias_sizes, mkldnn_f32, <a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2ba494a09557958694ff1aece6b4667d87f">mkldnn_x</a>));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(&amp;conv_dst_md, 4, conv_user_dst_sizes,</div>
<div class="line">            mkldnn_f32, <a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2bab7f14a435b0c6373badb9b3f296e6c1f">mkldnn_format_tag_any</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create a convolution</span></div>
<div class="line">    <a name="_a24"></a><a class="code" href="structmkldnn__convolution__desc__t.html">mkldnn_convolution_desc_t</a> conv_any_desc;</div>
<div class="line">    CHECK(<a name="a25"></a><a class="code" href="group__c__api__convolution.html#gabca75353551dd8c6912aa25ed3056f74">mkldnn_convolution_forward_desc_init</a>(&amp;conv_any_desc, <a name="a26"></a><a class="code" href="group__c__api__types__generic.html#gga5b98c8059c2aff8861157bf070c3f520a941ed539f3fbf685d3dd787c255c76f9">mkldnn_forward</a>,</div>
<div class="line">            <a name="a27"></a><a class="code" href="group__c__api__types__generic.html#ggaa27d43cdd1e439cc41a9580d23ce3e97ab90fddd0ca784280b9a37b3cc6fee0a3">mkldnn_convolution_direct</a>, &amp;conv_src_md, &amp;conv_weights_md,</div>
<div class="line">            &amp;conv_bias_md, &amp;conv_dst_md, conv_strides, conv_padding,</div>
<div class="line">            conv_padding));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__primitive__desc.html">mkldnn_primitive_desc_t</a> conv_pd;</div>
<div class="line">    CHECK(<a name="a28"></a><a class="code" href="group__c__api__primitive__common.html#gabca2c29dabdc558792fe39266a9c9843">mkldnn_primitive_desc_create</a>(</div>
<div class="line">            &amp;conv_pd, &amp;conv_any_desc, NULL, engine, NULL));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> conv_internal_src_memory, conv_internal_weights_memory,</div>
<div class="line">            conv_internal_dst_memory;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create memory for dst data, we don&#39;t need reorder it to user data</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *<a class="code" href="group__cpp__api__enums.html#gga6d88ff11a07bae09a5c348d314c5d1d9a701158248eed4e5fc84610f2f6026493">dst_md</a></div>
<div class="line">            = <a name="a29"></a><a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(conv_pd, <a name="a30"></a><a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9adccda04151e0c287f0de64b832d33ac4">mkldnn_query_dst_md</a>, 0);</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(&amp;conv_internal_dst_memory, dst_md, engine,</div>
<div class="line">            MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create reorder primitives between user data and convolution srcs</span></div>
<div class="line">    <span class="comment">// if required</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> conv_reorder_src, conv_reorder_weights;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *<a class="code" href="group__cpp__api__enums.html#gga6d88ff11a07bae09a5c348d314c5d1d9a90a729e395453e1d9411ad416c796819">src_md</a></div>
<div class="line">            = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(conv_pd, <a name="a31"></a><a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9a2bccd0a79be2c331227c353c294c3fbc">mkldnn_query_src_md</a>, 0);</div>
<div class="line">    CHECK(prepare_reorder(&amp;conv_user_src_memory, src_md, engine, 1,</div>
<div class="line">            &amp;conv_internal_src_memory, &amp;conv_reorder_src, &amp;n, net, net_args));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *<a class="code" href="group__cpp__api__enums.html#gga6d88ff11a07bae09a5c348d314c5d1d9a06ba7b00a8c95dcf3a90e16d00eeb0e9">weights_md</a> = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(</div>
<div class="line">            conv_pd, <a name="a32"></a><a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9a4d1661d6a50277029d02417f6b65435d">mkldnn_query_weights_md</a>, 0);</div>
<div class="line">    CHECK(prepare_reorder(&amp;conv_user_weights_memory, weights_md, engine, 1,</div>
<div class="line">            &amp;conv_internal_weights_memory, &amp;conv_reorder_weights, &amp;n, net,</div>
<div class="line">            net_args));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> conv_src_memory = conv_internal_src_memory ?</div>
<div class="line">            conv_internal_src_memory :</div>
<div class="line">            conv_user_src_memory;</div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> conv_weights_memory = conv_internal_weights_memory ?</div>
<div class="line">            conv_internal_weights_memory :</div>
<div class="line">            conv_user_weights_memory;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// finally create a convolution primitive</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> conv;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#ga7e9dba49f70cef016d9efcb542035eca">mkldnn_primitive_create</a>(&amp;conv, conv_pd));</div>
<div class="line">    net[n] = conv;</div>
<div class="line">    prepare_arg_node(&amp;net_args[n], 4);</div>
<div class="line">    set_arg(&amp;net_args[n].args[0], MKLDNN_ARG_SRC, conv_src_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[1], MKLDNN_ARG_WEIGHTS, conv_weights_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[2], MKLDNN_ARG_BIAS, conv_user_bias_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[3], MKLDNN_ARG_DST, conv_internal_dst_memory);</div>
<div class="line">    n++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// AlexNet: relu</span></div>
<div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, CONV_OH, CONV_OW}</span></div>
<div class="line">    <span class="keywordtype">float</span> negative_slope = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create relu memory descriptor on dst memory descriptor</span></div>
<div class="line">    <span class="comment">// from previous primitive</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *relu_src_md</div>
<div class="line">            = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(conv_pd, <a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9adccda04151e0c287f0de64b832d33ac4">mkldnn_query_dst_md</a>, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create a relu</span></div>
<div class="line">    <a name="_a33"></a><a class="code" href="structmkldnn__eltwise__desc__t.html">mkldnn_eltwise_desc_t</a> relu_desc;</div>
<div class="line">    CHECK(<a name="a34"></a><a class="code" href="group__c__api__eltwise.html#ga9cf5980e26f537653e5f0d4e00f984c7">mkldnn_eltwise_forward_desc_init</a>(&amp;relu_desc, <a class="code" href="group__c__api__types__generic.html#gga5b98c8059c2aff8861157bf070c3f520a941ed539f3fbf685d3dd787c255c76f9">mkldnn_forward</a>,</div>
<div class="line">            <a name="a35"></a><a class="code" href="group__c__api__types__generic.html#ggaa27d43cdd1e439cc41a9580d23ce3e97a66ead6848424f0b494e813745efb5548">mkldnn_eltwise_relu</a>, relu_src_md, negative_slope, 0));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__primitive__desc.html">mkldnn_primitive_desc_t</a> relu_pd;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gabca2c29dabdc558792fe39266a9c9843">mkldnn_primitive_desc_create</a>(</div>
<div class="line">            &amp;relu_pd, &amp;relu_desc, NULL, engine, NULL));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> relu_dst_memory;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *relu_dst_md</div>
<div class="line">            = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(relu_pd, <a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9adccda04151e0c287f0de64b832d33ac4">mkldnn_query_dst_md</a>, 0);</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(&amp;relu_dst_memory, relu_dst_md, engine,</div>
<div class="line">            MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// finally create a relu primitive</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> relu;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#ga7e9dba49f70cef016d9efcb542035eca">mkldnn_primitive_create</a>(&amp;relu, relu_pd));</div>
<div class="line">    net[n] = relu;</div>
<div class="line">    prepare_arg_node(&amp;net_args[n], 2);</div>
<div class="line">    set_arg(&amp;net_args[n].args[0], MKLDNN_ARG_SRC, conv_internal_dst_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[1], MKLDNN_ARG_DST, relu_dst_memory);</div>
<div class="line">    n++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// AlexNet: lrn</span></div>
<div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, CONV_OH, CONV_OW}</span></div>
<div class="line">    <span class="comment">// local size: 5</span></div>
<div class="line">    <span class="comment">// alpha: 0.0001</span></div>
<div class="line">    <span class="comment">// beta: 0.75</span></div>
<div class="line">    uint32_t local_size = 5;</div>
<div class="line">    <span class="keywordtype">float</span> alpha = 0.0001f;</div>
<div class="line">    <span class="keywordtype">float</span> beta = 0.75f;</div>
<div class="line">    <span class="keywordtype">float</span> k = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create lrn memory descriptor on dst memory descriptor</span></div>
<div class="line">    <span class="comment">//  from previous primitive</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *lrn_src_md = relu_dst_md;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create a lrn</span></div>
<div class="line">    <a name="_a36"></a><a class="code" href="structmkldnn__lrn__desc__t.html">mkldnn_lrn_desc_t</a> lrn_desc;</div>
<div class="line">    CHECK(<a name="a37"></a><a class="code" href="group__c__api__lrn.html#ga45738935851797f2c4ef374df53d9ef5">mkldnn_lrn_forward_desc_init</a>(&amp;lrn_desc, <a class="code" href="group__c__api__types__generic.html#gga5b98c8059c2aff8861157bf070c3f520a941ed539f3fbf685d3dd787c255c76f9">mkldnn_forward</a>,</div>
<div class="line">            <a name="a38"></a><a class="code" href="group__c__api__types__generic.html#ggaa27d43cdd1e439cc41a9580d23ce3e97a1ed17baabce0edc962f1dcfe83d09d5d">mkldnn_lrn_across_channels</a>, lrn_src_md, local_size, alpha, beta,</div>
<div class="line">            k));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__primitive__desc.html">mkldnn_primitive_desc_t</a> lrn_pd;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gabca2c29dabdc558792fe39266a9c9843">mkldnn_primitive_desc_create</a>(&amp;lrn_pd, &amp;lrn_desc, NULL, engine, NULL));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> lrn_dst_memory;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *lrn_dst_md</div>
<div class="line">            = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(lrn_pd, <a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9adccda04151e0c287f0de64b832d33ac4">mkldnn_query_dst_md</a>, 0);</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(&amp;lrn_dst_memory, lrn_dst_md, engine,</div>
<div class="line">            MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> lrn_ws_memory;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *lrn_ws_md = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(</div>
<div class="line">            lrn_pd, <a name="a39"></a><a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9a6f61e139512317e7f5653759e889d55d">mkldnn_query_workspace_md</a>, 0);</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(</div>
<div class="line">            &amp;lrn_ws_memory, lrn_ws_md, engine, MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// finally create a lrn primitive</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> lrn;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#ga7e9dba49f70cef016d9efcb542035eca">mkldnn_primitive_create</a>(&amp;lrn, lrn_pd));</div>
<div class="line">    net[n] = lrn;</div>
<div class="line">    prepare_arg_node(&amp;net_args[n], 3);</div>
<div class="line">    set_arg(&amp;net_args[n].args[0], MKLDNN_ARG_SRC, relu_dst_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[1], MKLDNN_ARG_DST, lrn_dst_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[2], MKLDNN_ARG_WORKSPACE, lrn_ws_memory);</div>
<div class="line">    n++;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// AlexNet: pool</span></div>
<div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, POOL_OH, POOL_OW}</span></div>
<div class="line">    <span class="comment">// kernel: {3, 3}</span></div>
<div class="line">    <span class="comment">// strides: {POOL_STRIDE, POOL_STRIDE}</span></div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> pool_dst_sizes[4] = { BATCH, OC, POOL_OH, POOL_OW };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> pool_kernel[2] = { 3, 3 };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> pool_strides[2] = { POOL_STRIDE, POOL_STRIDE };</div>
<div class="line">    <a class="code" href="group__c__api__types__memory.html#ga15898db3725cddbf807b85ef351ca81f">mkldnn_dim_t</a> pool_padding[2] = { POOL_PAD, POOL_PAD };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create pooling memory descriptor on dst descriptor</span></div>
<div class="line">    <span class="comment">//  from previous primitive</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *pool_src_md = lrn_dst_md;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create descriptors for dst pooling data</span></div>
<div class="line">    <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> pool_dst_any_md;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#gaa8895ff6e661d8fe1cdeae76e6e20bbc">mkldnn_memory_desc_init_by_tag</a>(&amp;pool_dst_any_md, 4, pool_dst_sizes,</div>
<div class="line">            mkldnn_f32, <a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2bab7f14a435b0c6373badb9b3f296e6c1f">mkldnn_format_tag_any</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create memory for user data</span></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> pool_user_dst_memory;</div>
<div class="line">    init_data_memory(4, pool_dst_sizes, <a class="code" href="group__c__api__types__generic.html#ggacc2844e341ab1c4f5b7ae1c6068f2a2baed4a51a8db128a648b942882369a06d6">mkldnn_nchw</a>, mkldnn_f32, engine,</div>
<div class="line">            net_dst, &amp;pool_user_dst_memory);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create a pooling</span></div>
<div class="line">    <a name="_a40"></a><a class="code" href="structmkldnn__pooling__desc__t.html">mkldnn_pooling_desc_t</a> pool_desc;</div>
<div class="line">    CHECK(<a name="a41"></a><a class="code" href="group__c__api__pooling.html#gae3f1616c53a2258957c1a152f9da4497">mkldnn_pooling_forward_desc_init</a>(&amp;pool_desc, <a class="code" href="group__c__api__types__generic.html#gga5b98c8059c2aff8861157bf070c3f520a941ed539f3fbf685d3dd787c255c76f9">mkldnn_forward</a>,</div>
<div class="line">            <a name="a42"></a><a class="code" href="group__c__api__types__generic.html#ggaa27d43cdd1e439cc41a9580d23ce3e97a38644ce471217d36eab206d0bc144e57">mkldnn_pooling_max</a>, pool_src_md, &amp;pool_dst_any_md, pool_strides,</div>
<div class="line">            pool_kernel, pool_padding, pool_padding));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__primitive__desc.html">mkldnn_primitive_desc_t</a> pool_pd;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gabca2c29dabdc558792fe39266a9c9843">mkldnn_primitive_desc_create</a>(</div>
<div class="line">            &amp;pool_pd, &amp;pool_desc, NULL, engine, NULL));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create memory for workspace</span></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> pool_ws_memory;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *pool_ws_md = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(</div>
<div class="line">            pool_pd, <a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9a6f61e139512317e7f5653759e889d55d">mkldnn_query_workspace_md</a>, 0);</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__memory.html#ga16a5d3f01dd47973868ef49241a2d4ef">mkldnn_memory_create</a>(&amp;pool_ws_memory, pool_ws_md, engine,</div>
<div class="line">            MKLDNN_MEMORY_ALLOCATE));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> pool_dst_memory;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// create reorder primitives between user data and pooling dsts</span></div>
<div class="line">    <span class="comment">// if required</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> pool_reorder_dst;</div>
<div class="line">    <a class="code" href="structmkldnn__memory.html">mkldnn_memory_t</a> pool_internal_dst_memory;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structmkldnn__memory__desc__t.html">mkldnn_memory_desc_t</a> *pool_dst_md</div>
<div class="line">            = <a class="code" href="group__c__api__primitive__common.html#ga9e14963d6bdb1aed934ffb059421fcfc">mkldnn_primitive_desc_query_md</a>(pool_pd, <a class="code" href="group__c__api__types__query.html#gga6eebc661a8a3437b49d9c677f8972fc9adccda04151e0c287f0de64b832d33ac4">mkldnn_query_dst_md</a>, 0);</div>
<div class="line">    n += 1; <span class="comment">// tentative workaround: preserve space for pooling that should</span></div>
<div class="line">            <span class="comment">// happen before the reorder</span></div>
<div class="line">    CHECK(prepare_reorder(&amp;pool_user_dst_memory, pool_dst_md, engine, 0,</div>
<div class="line">            &amp;pool_internal_dst_memory, &amp;pool_reorder_dst, &amp;n, net, net_args));</div>
<div class="line">    n -= pool_reorder_dst ? 2 : 1;</div>
<div class="line"></div>
<div class="line">    pool_dst_memory = pool_internal_dst_memory ? pool_internal_dst_memory :</div>
<div class="line">                                                 pool_user_dst_memory;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// finally create a pooling primitive</span></div>
<div class="line">    <a class="code" href="structmkldnn__primitive.html">mkldnn_primitive_t</a> pool;</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#ga7e9dba49f70cef016d9efcb542035eca">mkldnn_primitive_create</a>(&amp;pool, pool_pd));</div>
<div class="line">    net[n] = pool;</div>
<div class="line">    prepare_arg_node(&amp;net_args[n], 3);</div>
<div class="line">    set_arg(&amp;net_args[n].args[0], MKLDNN_ARG_SRC, lrn_dst_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[1], MKLDNN_ARG_DST, pool_dst_memory);</div>
<div class="line">    set_arg(&amp;net_args[n].args[2], MKLDNN_ARG_WORKSPACE, pool_ws_memory);</div>
<div class="line">    n++;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pool_reorder_dst)</div>
<div class="line">        n += 1;</div>
<div class="line"></div>
<div class="line">    <a name="_a43"></a><a class="code" href="structmkldnn__stream.html">mkldnn_stream_t</a> stream;</div>
<div class="line">    CHECK(<a name="a44"></a><a class="code" href="group__c__api__stream.html#ga762c9bc77e3d25fb30ece922c1545df7">mkldnn_stream_create</a>(&amp;stream, engine, <a name="a45"></a><a class="code" href="group__c__api__types__stream.html#gga99541103c9e9f6241d7a312d39d2cff2a8048500bb95413112046344427918c2d">mkldnn_stream_default_flags</a>));</div>
<div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; n; ++i) {</div>
<div class="line">        CHECK(<a name="a46"></a><a class="code" href="group__c__api__primitive__common.html#ga3b410ce7d1cd3fede1ed80394ed3dacf">mkldnn_primitive_execute</a>(</div>
<div class="line">                net[i], stream, net_args[i].nargs, net_args[i].args));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    CHECK(<a name="a47"></a><a class="code" href="group__c__api__stream.html#ga3ee76b12d1d634363c66f66f1d423a07">mkldnn_stream_wait</a>(stream));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// clean-up</span></div>
<div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; n; ++i)</div>
<div class="line">        free_arg_node(&amp;net_args[i]);</div>
<div class="line"></div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gacad44a12c7d863fb47dc02a76b4b794a">mkldnn_primitive_desc_destroy</a>(conv_pd));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gacad44a12c7d863fb47dc02a76b4b794a">mkldnn_primitive_desc_destroy</a>(relu_pd));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gacad44a12c7d863fb47dc02a76b4b794a">mkldnn_primitive_desc_destroy</a>(lrn_pd));</div>
<div class="line">    CHECK(<a class="code" href="group__c__api__primitive__common.html#gacad44a12c7d863fb47dc02a76b4b794a">mkldnn_primitive_desc_destroy</a>(pool_pd));</div>
<div class="line"></div>
<div class="line">    <a name="a48"></a><a class="code" href="group__c__api__stream.html#gae10ec69089229b220a8123faa8ed1c99">mkldnn_stream_destroy</a>(stream);</div>
<div class="line"></div>
<div class="line">    free(net_src);</div>
<div class="line">    free(net_dst);</div>
<div class="line"></div>
<div class="line">    <a name="a49"></a><a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_user_src_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_user_weights_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_user_bias_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_internal_src_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_internal_weights_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(conv_internal_dst_memory);</div>
<div class="line">    <a name="a50"></a><a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(conv_reorder_src);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(conv_reorder_weights);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(conv);</div>
<div class="line"></div>
<div class="line">    free(conv_weights);</div>
<div class="line">    free(conv_bias);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(relu_dst_memory);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(relu);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(lrn_ws_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(lrn_dst_memory);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(lrn);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(pool_user_dst_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(pool_internal_dst_memory);</div>
<div class="line">    <a class="code" href="group__c__api__memory.html#ga505acdd7d07d543098fef63261f57c30">mkldnn_memory_destroy</a>(pool_ws_memory);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(pool_reorder_dst);</div>
<div class="line">    <a class="code" href="group__c__api__primitive__common.html#ga083d8c44cc398146be7056c7b450ee83">mkldnn_primitive_destroy</a>(pool);</div>
<div class="line"></div>
<div class="line">    <a name="a51"></a><a class="code" href="group__c__api__engine.html#gaa6610c08cc39592b28d04535fb9db2d3">mkldnn_engine_destroy</a>(engine);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__c__api__types__generic.html#gga31866789b66acfb1c28b2f9bdd7bdfddab50eb3f75584f0495802ffb5e0a9884f">mkldnn_success</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div>
<div class="line">    <a class="code" href="group__c__api__types__generic.html#ga31866789b66acfb1c28b2f9bdd7bdfdd">mkldnn_status_t</a> result = simple_net();</div>
<div class="line">    printf(<span class="stringliteral">&quot;%s\n&quot;</span>, (result == <a class="code" href="group__c__api__types__generic.html#gga31866789b66acfb1c28b2f9bdd7bdfddab50eb3f75584f0495802ffb5e0a9884f">mkldnn_success</a>) ? <span class="stringliteral">&quot;passed&quot;</span> : <span class="stringliteral">&quot;failed&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>