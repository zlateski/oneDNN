<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>DNNL: Pooling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">Deep Neural Network Library (DNNL)
   &#160;<span id="projectnumber">1.1.3</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Pooling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p></p>
<p>API reference: <a class="el" href="group__c__api__pooling.html">C</a>, <a class="el" href="group__cpp__api__pooling.html">C++</a></p>
<p></p>
</blockquote>
<p>The pooling primitive performs forward or backward max or average pooling operation on 2D or 3D spatial data.</p>
<p>The pooling operation is defined by the following formulas. We show formulas only for 2D spatial data which are straightforward to generalize to cases of higher and lower dimensions. Variable names follow the standard <a class="el" href="dev_guide_conventions.html">Naming Conventions</a>.</p>
<h3>Forward</h3>
<p>Max pooling:</p>
<p class="formulaDsp">
\[ dst(n, c, oh, ow) = \max\limits_{kh, kw} \left( src(n, c, oh \cdot SH + kh - ph_0, ow \cdot SW +kw - pw_0) \right) \]
</p>
<p>Average pooling:</p>
<p class="formulaDsp">
\[ dst(n, c, oh, ow) = \frac{1}{DENOM} \sum\limits_{kh, kw} src(n, c, oh \cdot SH + kh - ph_0, ow \cdot SW +kw - pw_0) \]
</p>
<p>where \(ph_0, pw_0\) are <code>padding_l[0]</code> and <code>padding_l[1]</code> respectively, and output spatial dimensions are calculated similarly to how they are done in convolution.</p>
<p>Average pooling supports two algorithms:</p>
<ul>
<li><a class="el" href="group__c__api__types__generic.html#gga96946c805f6c4922c38c37049ab95d23ac13a4cc7c0dc1edfcbf1bac23391d5cb" title="Average pooling include padding. ">dnnl_pooling_avg_include_padding</a>, in which case \(DENOM = KH \cdot KW\),</li>
<li><a class="el" href="group__c__api__types__generic.html#gga96946c805f6c4922c38c37049ab95d23a00156580493fd7c2f4cdbaaf9fcbde79" title="Average pooling exclude padding. ">dnnl_pooling_avg_exclude_padding</a>, in which case \(DENOM\) equals to the size of overlap between an averaging window and images.</li>
</ul>
<blockquote class="doxtable">
<p>TODO: a picture would be nice here.</p>
<p></p>
</blockquote>
<h4>Difference Between <a href="#dnnl_forward_training">Forward Training</a> and <a href="#dnnl_forward_inference">Forward Inference</a></h4>
<ul>
<li>Max pooling requires <code>workspace</code> output for the <a class="el" href="group__c__api__types__generic.html#ggae3c1f22ae55645782923fbfd8b07d0c4a992e03bebfe623ac876b3636333bbce0" title="Forward data propagation (training mode). ">dnnl_forward_training</a> propagation kind, and doesn't require it for <a class="el" href="group__c__api__types__generic.html#ggae3c1f22ae55645782923fbfd8b07d0c4a2f77a568a675dec649eb0450c997856d" title="Forward data propagation (inference mode). ">dnnl_forward_inference</a> (see details below).</li>
</ul>
<h3>Backward</h3>
<p>The backward propagation computes \(diff\_src(n, c, h, w)\), based on \(diff\_dst(n, c, h, w)\) and (in case of max pooling) <code>workspace</code>.</p>
<h2>Implementation Details</h2>
<h3>General Notes</h3>
<ol type="1">
<li>During training, max pooling requires a workspace on forward (<a class="el" href="group__c__api__types__generic.html#ggae3c1f22ae55645782923fbfd8b07d0c4a992e03bebfe623ac876b3636333bbce0" title="Forward data propagation (training mode). ">dnnl_forward_training</a>) and backward passes to save indices where a maximum was found. The workspace format is opaque, and the indices cannot be restored from it. However, one can use backward pooling to perform up-sampling (used in some detection topologies).</li>
<li>A user can use memory format tag <a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac" title="Undefined memory format tag. ">dnnl_format_tag_any</a> for <code>dst</code> memory descriptor when creating pooling forward propagation. The library would derive the appropriate format from the <code>src</code> memory descriptor. However, the <code>src</code> itself must be defined. Similarly, a user can use memory format tag <a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac" title="Undefined memory format tag. ">dnnl_format_tag_any</a> for the<code>diff_src</code> memory descriptor when creating pooling backward propagation.</li>
</ol>
<h3>Data Type Support</h3>
<p>The pooling primitive supports the following combinations of data types:</p>
<table class="doxtable">
<tr>
<th align="left">Propagation </th><th align="left">Source / Destination </th><th align="left">Accumulation data type (used for average pooling only)  </th></tr>
<tr>
<td align="left">forward / backward </td><td align="left">f32, bf16 </td><td align="left">f32 </td></tr>
<tr>
<td align="left">forward </td><td align="left">f16 </td><td align="left">f16 </td></tr>
<tr>
<td align="left">forward </td><td align="left">s8, u8, s32 </td><td align="left">s32 </td></tr>
</table>
<dl class="section warning"><dt>Warning</dt><dd>There might be hardware and/or implementation specific restrictions. Check <a class="el" href="dev_guide_pooling.html#dg_pool_impl_limits">Implementation Limitations</a> section below.</dd></dl>
<h3>Data Representation</h3>
<h4>Source, Destination, and Their Gradients</h4>
<p>Like other CNN primitives, the pooling primitive expects data to be \(N \times C \times H \times W\) tensor in case 2D spatial data and \(N \times C \times D \times H \times W\) tensor in case 3D spatial data.</p>
<p>The pooling primitive is optimized for the following memory formats:</p>
<table class="doxtable">
<tr>
<th align="left">Spatial </th><th align="left">Logical tensor </th><th align="left">Data type </th><th align="left">Implementations optimized for memory formats  </th></tr>
<tr>
<td align="left">2D </td><td align="left">NCHW </td><td align="left">f32 </td><td align="left"><a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da83a751aedeb59613312339d0f8b90f54" title="4D CNN activations tensor, an alias to dnnl_abcd ">dnnl_nchw</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da6e669cc61278663a5ddbd3d0b25c6c5c" title="plain 4D tensor ">dnnl_abcd</a>), <a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091dae50c534446b3c18cc018b3946b3cebd7" title="4D CNN activations tensor, an alias to dnnl_acdb ">dnnl_nhwc</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da8fcce5dd7260b5b0740e3b37b1e9ad41" title="permuted 4D tensor ">dnnl_acdb</a>), <em>optimized^</em> </td></tr>
<tr>
<td align="left">2D </td><td align="left">NCHW </td><td align="left">s32, s8, u8 </td><td align="left"><a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091dae50c534446b3c18cc018b3946b3cebd7" title="4D CNN activations tensor, an alias to dnnl_acdb ">dnnl_nhwc</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da8fcce5dd7260b5b0740e3b37b1e9ad41" title="permuted 4D tensor ">dnnl_acdb</a>), <em>optimized^</em> </td></tr>
<tr>
<td align="left">3D </td><td align="left">NCDHW </td><td align="left">f32 </td><td align="left"><a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091dae33b8c6790e5d37324f18a019658d464" title="5D CNN activations tensor, an alias to dnnl_abcde ">dnnl_ncdhw</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da30d5d3c9de2931f06d265af81787ada3" title="plain 5D tensor ">dnnl_abcde</a>), <a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091daa0d8b24eefd029e214080d3787114fc2" title="5D CNN activations tensor, an alias to dnnl_acdeb ">dnnl_ndhwc</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da0cfe86402763786b9b4d73062cfd2f05" title="permuted 5D tensor ">dnnl_acdeb</a>), <em>optimized^</em> </td></tr>
<tr>
<td align="left">3D </td><td align="left">NCDHW </td><td align="left">s32, s8, u8 </td><td align="left"><a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091daa0d8b24eefd029e214080d3787114fc2" title="5D CNN activations tensor, an alias to dnnl_acdeb ">dnnl_ndhwc</a> (<a class="el" href="group__c__api__types__generic.html#gga395e42b594683adb25ed2d842bb3091da0cfe86402763786b9b4d73062cfd2f05" title="permuted 5D tensor ">dnnl_acdeb</a>), <em>optimized^</em> </td></tr>
</table>
<p>Here <em>optimized^</em> means the format that <a class="el" href="memory_format_propagation_cpp.html">comes out</a> of any preceding compute-intensive primitive.</p>
<h3>Post-ops and Attributes</h3>
<p>The pooling primitive doesn't support any post-ops or attributes.</p>
<p><a class="anchor" id="dg_pool_impl_limits"></a></p>
<h2>Implementation Limitations</h2>
<ol type="1">
<li>No primitive specific limitations. Refer to <a class="el" href="dev_guide_data_types.html">Data Types</a> for limitations related to data types support.</li>
</ol>
<h2>Performance Tips</h2>
<p>N/A </p>
</div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>